<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Snap In Synth</title>
  <link href="style/main.css" rel="stylesheet">
  <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://fb.me/react-0.13.1.js"></script>
  <script src="https://fb.me/JSXTransformer-0.13.1.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <script src="js/lib/timbre.js"></script>
  <style>
    .module {
      border: 1px solid black;
      display: inline-block;
      padding: 1rem;
    }
  </style>
</head>

<body>
  <div id="content"></div>

  <script type="text/jsx">
    var Page = React.createClass({

      getInitialState: function() {
          return {
            modules: [{
                name: 'osc',
                type: 'sin',
                properties: {wave:'sin', freq:500},
            }],
            sequence: null,
          };
        },

        addNewOsc: function() {
          var modules = this.state.modules
          modules.push({
            name: 'osc',
            type: 'sin',
            properties: {wave:'sin', freq:500},
          });
          this.setState({modules: modules});
        },

        oscChanged: function(i, values) {
          var modules = this.state.modules;
          modules[i] = values;
          this.setState({modules: modules});
        },

      togglePlay: function() {
        if (this.state.sequence == null) {this.play();}
        else {this.pause();}
      },

        play: function() {
          if (this.state.sequence != null) {
            //pause first so we're not playing multiple sequences
            this.state.sequence.pause();
          }
          var sequence = null;
          this.state.modules.forEach(function (m) {
            if (sequence == null) {
              sequence = T(m.name, m.properties);
            } else {
              sequence = sequence.append(T(m.name, m.properties));
            }
          });
          this.setState({sequence: sequence});
          sequence.play();
          console.log('playing');
        },

      pause: function() {
        if (this.state.sequence != null) {
          this.state.sequence.pause();
          this.state.sequence = null
        }
      },

      render: function() {
        return (
          <div>
            {this.state.modules.map(function(s, i) {
              return <Module key={i} o={s} id={i} changed={this.oscChanged} />;
            }.bind(this))}
            <PlusButton addNewOsc={this.addNewOsc} />
            <PlayButton playFn={this.togglePlay} />
          </div>
        );
      }
    });

    var Module = React.createClass({
      changed: function() {
        var freq = $(this.getDOMNode()).find('input').val();
        var module = JSON.parse(JSON.stringify(this.props.o));
        module.properties.freq = parseInt(freq);
        this.props.changed(this.props.id, module);
      },
      render: function() {
        return (
          <div className='module'>
            {this.props.o.type}
            <input type='range' min='0' max='2600' step='1' onChange={this.changed} />
          </div>
        );
      }
    });

    var PlusButton = React.createClass({
      render: function() {
        return (
          <div id='AddButton' onClick={this.props.addNewOsc}>
            Add a new oscillator
          </div>
        )
      }
    });

    var PlayButton = React.createClass({
      render: function() {
        return (
          <div onClick={this.props.playFn}>
            Play
          </div>
        )
      }
    });

    React.render(
      <Page />,
      document.getElementById('content')
    );
  </script>
</body>
</html>
